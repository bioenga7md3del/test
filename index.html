<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الفواتير - Technical Report</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #2980b9;
            --success-color: #27ae60;
            --bg-color: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
        }

        /* تنسيق التبويبات */
        .tabs {
            max-width: 850px;
            margin: 0 auto;
            display: flex;
            gap: 10px;
            margin-bottom: 0;
        }

        .tab-btn {
            padding: 12px 25px;
            background: #bdc3c7;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            flex: 1;
            transition: 0.3s;
        }

        .tab-btn.active {
            background: white;
            color: var(--accent-color);
            border-top: 3px solid var(--accent-color);
        }

        /* حاوية النموذج */
        .container {
            background: white;
            max-width: 850px;
            margin: 0 auto;
            padding: 30px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        h2, h3 {
            color: var(--primary-color);
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .full-width {
            grid-column: span 2;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 14px;
        }

        .form-group input:focus {
            border-color: var(--accent-color);
            outline: none;
        }

        /* حقول القراءة فقط */
        .readonly-field {
            background-color: #f8f9fa;
            border-color: #e9ecef;
            color: #495057;
            font-weight: bold;
        }

        /* الأزرار */
        .btn-action {
            display: block;
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-save {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-print {
            background-color: var(--success-color);
            color: white;
        }

        .btn-print:hover { background-color: #219150; }
        .btn-save:hover { background-color: #1a252f; }

        /* ==================== تنسيق الطباعة (مخفي) ==================== */
        #print-view {
            display: none;
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 10mm;
            margin: 0 auto;
            color: black;
            font-family: Arial, sans-serif;
            box-sizing: border-box;
            direction: ltr; /* التقرير بالإنجليزي */
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .report-table th, .report-table td {
            border: 1px solid black;
            padding: 4px 8px;
            text-align: left;
        }
        
        .no-border td { border: none; }

        .header-title {
            text-align: center;
            font-weight: bold;
            text-decoration: underline;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .signatures {
            margin-top: 40px;
            display: flex;
            justify-content: space-between;
        }

        .signature-box {
            width: 40%;
            text-align: center;
        }

        /* ==================== إعدادات الميديا للطباعة ==================== */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-view, #print-view * {
                visibility: visible;
            }
            #print-view {
                display: block;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 10mm;
            }
            @page {
                size: A4;
                margin: 0;
            }
        }
    </style>
</head>
<body>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('invoice')">بيانات الفاتورة (Invoice)</button>
        <button class="tab-btn" onclick="switchTab('settings')">الإعدادات والثوابت (Settings)</button>
    </div>

    <div class="container">
        
        <div id="invoice-tab" class="tab-content active">
            <h2>إدخال البيانات المتغيرة</h2>
            <div class="form-grid">
                <div class="form-group"><label>التاريخ (Date):</label><input type="date" id="in_date"></div>
                <div class="form-group"><label>رقم الفاتورة (Invoice #):</label><input type="text" id="in_inv_num"></div>
                
                <div class="form-group"><label>اسم المورد (Vendor Eng):</label><input type="text" id="in_vendor_eng"></div>
                <div class="form-group"><label>اسم المورد (عربي):</label><input type="text" id="in_vendor_arab"></div>
                
                <div class="form-group"><label>رقم أمر الشراء (FGC PO#):</label><input type="text" id="in_fgc_po"></div>
                <div class="form-group"><label>تاريخ الفاتورة (Inv. Date):</label><input type="date" id="in_inv_date"></div>

                <div class="full-width"><hr></div>

                <div class="form-group">
                    <label>المبلغ الأساسي (Amount):</label>
                    <input type="number" step="0.01" id="in_amount" oninput="calculateFinancials()" placeholder="أدخل المبلغ هنا">
                </div>
                
                <div class="form-group">
                    <label>ضريبة القيمة المضافة (VAT): <small id="vat_display_rate"></small></label>
                    <input type="text" id="in_vat" class="readonly-field" readonly>
                </div>
                
                <div class="form-group full-width">
                    <label>الإجمالي (Total Amount):</label>
                    <input type="text" id="in_total" class="readonly-field" readonly style="font-size: 18px; color: #2c3e50;">
                </div>

                <div class="form-group full-width">
                    <label>فقط (SAR):</label>
                    <input type="text" id="in_words" class="readonly-field" readonly>
                </div>
            </div>
            <button class="btn-action btn-print" onclick="printReport()">طباعة التقرير</button>
        </div>

        <div id="settings-tab" class="tab-content">
            <h2>إعداد الثوابت (يتم حفظها تلقائياً)</h2>
            <p style="color: #666; font-size: 13px;">هذه البيانات ستظهر ثابتة في كل الفواتير ولا تحتاج لإدخالها كل مرة.</p>
            
            <div class="form-grid">
                <div class="form-group"><label>Division Name:</label><input type="text" id="set_division"></div>
                <div class="form-group"><label>Section Name:</label><input type="text" id="set_section"></div>
                <div class="form-group"><label>Project Name:</label><input type="text" id="set_project"></div>
                <div class="form-group"><label>Site Name:</label><input type="text" id="set_site"></div>
                <div class="form-group"><label>Site Ref.#:</label><input type="text" id="set_site_ref"></div>
                <div class="form-group"><label>Prepared By (Name):</label><input type="text" id="set_prepared"></div>
                
                <div class="form-group full-width">
                    <label>نسبة الضريبة (VAT %) - كرقم صحيح:</label>
                    <input type="number" id="set_vat_rate" value="15" placeholder="15">
                </div>
            </div>
            <button class="btn-action btn-save" onclick="saveSettings()">حفظ الإعدادات</button>
        </div>

    </div>

    <div id="print-view">
        <div class="header-title">
            Technical Report<br>
            SPARE PARTS SETTLEMENT INVOICE
        </div>

        <table class="report-table no-border" style="width: 100%; margin-bottom: 20px;">
            <tr>
                <td style="width: 60%;"></td> 
                <td style="width: 15%; font-weight: bold;">Date :</td>
                <td style="width: 25%; border-bottom: 1px solid #000;"><span id="out_date"></span></td>
            </tr>
            <tr>
                <td></td>
                <td style="font-weight: bold;">Division Name :</td>
                <td style="border-bottom: 1px solid #000;"><span id="out_division"></span></td>
            </tr>
            <tr>
                <td style="font-weight: bold;">33</td>
                <td style="font-weight: bold;">Section Name :</td>
                <td style="border-bottom: 1px solid #000;"><span id="out_section"></span></td>
            </tr>
            <tr>
                <td></td>
                <td style="font-weight: bold;">Project Name :</td>
                <td style="border-bottom: 1px solid #000;"><span id="out_project"></span></td>
            </tr>
            <tr>
                <td></td>
                <td style="font-weight: bold;">Site Name :</td>
                <td style="border-bottom: 1px solid #000;"><span id="out_site"></span></td>
            </tr>
            <tr>
                <td colspan="3" style="padding-top: 10px;">Supporting Documentation Attached: <b>Serial No :</b> ________________</td>
            </tr>
        </table>

        <table class="report-table no-border">
            <tr>
                <td style="width: 20%; font-weight: bold;">Vendor/ Name Eng:</td>
                <td style="border-bottom: 1px solid #000;"><span id="out_vendor_eng"></span></td>
            </tr>
            <tr>
                <td style="font-weight: bold;">Vendor/ Name Arab:</td>
                <td style="border-bottom: 1px solid #000; text-align: right;"><span id="out_vendor_arab"></span></td>
            </tr>
        </table>
        <br>

        <table class="report-table" style="text-align: center;">
            <thead style="background-color: #f0f0f0;">
                <tr>
                    <th>S.N</th>
                    <th>Site Ref.#</th>
                    <th>FGC PO#</th>
                    <th>Invoice #</th>
                    <th>Inv. Date</th>
                    <th>Amount</th>
                    <th>VAT</th>
                    <th>Total Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1</td>
                    <td><span id="out_site_ref"></span></td>
                    <td><span id="out_fgc_po"></span></td>
                    <td><span id="out_inv_num"></span></td>
                    <td><span id="out_inv_date"></span></td>
                    <td><span id="out_amount"></span></td>
                    <td><span id="out_vat"></span></td>
                    <td><span id="out_total_row"></span></td>
                </tr>
                <tr>
                    <td colspan="7" style="text-align: right; font-weight: bold;">TOTAL AMOUNT</td>
                    <td style="font-weight: bold;"><span id="out_total_final"></span></td>
                </tr>
            </tbody>
        </table>

        <div style="margin: 10px 0;">
            <b>In Word (SAR):</b> <span id="out_words" style="text-decoration: underline;"></span>
        </div>

        <div style="margin: 20px 0; border: 1px solid #000; padding: 10px;">
            <b>The Report:</b><br>
            Material has been Requested by the site as per the purchase Order and work has to be done as per attachments from the site.
        </div>

        <div class="signatures">
            <div class="signature-box">
                <b>Prepared By:</b>
                <br><br><br>
                Name: <span id="out_prepared"></span>
            </div>
            <div class="signature-box">
                <b>Approved By:</b>
                <br><br><br>
                Name: <b>Mahmoud Sarhan</b><br>
                Medical Maintenance Projects Manager
            </div>
        </div>
    </div>

    <script>
        // دالة التبديل بين التبويبات
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // ================== إدارة الإعدادات (Local Storage) ==================
        function saveSettings() {
            const settings = {
                division: document.getElementById('set_division').value,
                section: document.getElementById('set_section').value,
                project: document.getElementById('set_project').value,
                site: document.getElementById('set_site').value,
                site_ref: document.getElementById('set_site_ref').value,
                prepared: document.getElementById('set_prepared').value,
                vat_rate: document.getElementById('set_vat_rate').value
            };
            localStorage.setItem('invoiceSettings', JSON.stringify(settings));
            alert('تم حفظ الإعدادات بنجاح!');
            calculateFinancials(); // إعادة الحساب في حال تغيرت النسبة
        }

        function loadSettings() {
            const saved = localStorage.getItem('invoiceSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('set_division').value = settings.division || '';
                document.getElementById('set_section').value = settings.section || '';
                document.getElementById('set_project').value = settings.project || '';
                document.getElementById('set_site').value = settings.site || '';
                document.getElementById('set_site_ref').value = settings.site_ref || '';
                document.getElementById('set_prepared').value = settings.prepared || '';
                document.getElementById('set_vat_rate').value = settings.vat_rate || '15';
            } else {
                // قيم افتراضية
                document.getElementById('set_vat_rate').value = '15';
            }
        }

        // ================== الحسابات المالية والتفقيط ==================
        function calculateFinancials() {
            const amount = parseFloat(document.getElementById('in_amount').value) || 0;
            const vatRate = parseFloat(document.getElementById('set_vat_rate').value) || 15;
            
            const vat = amount * (vatRate / 100);
            const total = amount + vat;

            // تحديث الواجهة
            document.getElementById('vat_display_rate').innerText = `(${vatRate}%)`;
            document.getElementById('in_vat').value = vat.toFixed(2);
            document.getElementById('in_total').value = total.toFixed(2);
            
            // تحويل الرقم إلى كلمات
            document.getElementById('in_words').value = tafqeet(total);
        }

        // دالة تفقيط بسيطة وفعالة للريال السعودي
        function tafqeet(number) {
            if (number === 0) return "";
            
            const parts = number.toFixed(2).toString().split('.');
            const riyals = parseInt(parts[0]);
            const halalas = parseInt(parts[1]);

            let text = "فقط ";
            
            if (riyals > 0) {
                text += numberToText(riyals) + " ريال سعودي";
            }
            
            if (halalas > 0) {
                if (riyals > 0) text += " و ";
                text += numberToText(halalas) + " هللة";
            }
            
            text += " لا غير";
            return text;
        }

        function numberToText(n) {
            const units = ["", "واحد", "اثنان", "ثلاثة", "أربعة", "خمسة", "ستة", "سبعة", "ثمانية", "تسعة"];
            const teens = ["عشرة", "أحد عشر", "اثنا عشر", "ثلاثة عشر", "أربعة عشر", "خمسة عشر", "ستة عشر", "سبعة عشر", "ثمانية عشر", "تسعة عشر"];
            const tens = ["", "", "عشرون", "ثلاثون", "أربعون", "خمسون", "ستون", "سبعون", "ثمانون", "تسعون"];
            const hundreds = ["", "مائة", "مائتان", "ثلاثمائة", "أربعمائة", "خمسمائة", "ستمائة", "سبعمائة", "ثمانمائة", "تسعمائة"];
            const thousands = ["", "ألف", "ألفان", "ثلاثة آلاف", "أربعة آلاف", "خمسة آلاف", "ستة آلاف", "سبعة آلاف", "ثمانية آلاف", "تسعة آلاف"];

            if (n < 10) return units[n];
            if (n < 20) return teens[n - 10];
            if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 ? " و" + units[n % 10] : "");
            if (n < 1000) return hundreds[Math.floor(n / 100)] + (n % 100 ? " و" + numberToText(n % 100) : "");
            if (n < 10000) return thousands[Math.floor(n / 1000)] + (n % 1000 ? " و" + numberToText(n % 1000) : "");
            if (n < 1000000) {
                let k = Math.floor(n / 1000);
                let textK = k > 10 ? numberToText(k) + " ألف" : numberToText(k * 1000); // تبسيط للألوف المركبة
                if (k > 2 && k <= 10) textK = thousands[k]; // حالة خاصة 3-10 آلاف
                return textK + (n % 1000 ? " و" + numberToText(n % 1000) : "");
            }
            return n; // للأرقام الكبيرة جداً نرجع الرقم كما هو لتجنب التعقيد الزائد
        }

        // ================== الطباعة ==================
        function printReport() {
            // 1. جلب الإعدادات المحفوظة أو من الحقول
            const division = document.getElementById('set_division').value;
            const section = document.getElementById('set_section').value;
            const project = document.getElementById('set_project').value;
            const site = document.getElementById('set_site').value;
            const siteRef = document.getElementById('set_site_ref').value;
            const prepared = document.getElementById('set_prepared').value;

            // 2. تعبئة التقرير بالبيانات الثابتة
            document.getElementById('out_division').innerText = division;
            document.getElementById('out_section').innerText = section;
            document.getElementById('out_project').innerText = project;
            document.getElementById('out_site').innerText = site;
            document.getElementById('out_site_ref').innerText = siteRef;
            document.getElementById('out_prepared').innerText = prepared;

            // 3. تعبئة التقرير بالبيانات المتغيرة
            document.getElementById('out_date').innerText = document.getElementById('in_date').value;
            document.getElementById('out_vendor_eng').innerText = document.getElementById('in_vendor_eng').value;
            document.getElementById('out_vendor_arab').innerText = document.getElementById('in_vendor_arab').value;
            document.getElementById('out_fgc_po').innerText = document.getElementById('in_fgc_po').value;
            document.getElementById('out_inv_num').innerText = document.getElementById('in_inv_num').value;
            document.getElementById('out_inv_date').innerText = document.getElementById('in_inv_date').value;

            // 4. تعبئة الأرقام المالية
            document.getElementById('out_amount').innerText = document.getElementById('in_amount').value;
            document.getElementById('out_vat').innerText = document.getElementById('in_vat').value;
            document.getElementById('out_total_row').innerText = document.getElementById('in_total').value;
            document.getElementById('out_total_final').innerText = document.getElementById('in_total').value;
            document.getElementById('out_words').innerText = document.getElementById('in_words').value;

            window.print();
        }

        // عند تحميل الصفحة
        window.onload = function() {
            loadSettings();
            // وضع تاريخ اليوم كافتراضي
            document.getElementById('in_date').valueAsDate = new Date();
        };
    </script>
</body>
</html>
